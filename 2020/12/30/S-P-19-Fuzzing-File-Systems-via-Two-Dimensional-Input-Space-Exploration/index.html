<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"harperchen.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="AbstractFile systems, a basic building block of an OS, are too big and too complex to be bug free. Nevertheless, file systems rely on regular stress-testing tools and formal checkers to find bugs, whi">
<meta property="og:type" content="article">
<meta property="og:title" content="[S&amp;P&#39;19] Fuzzing File Systems via Two-Dimensional Input Space Exploration">
<meta property="og:url" content="https://harperchen.github.io/blog/2020/12/30/S-P-19-Fuzzing-File-Systems-via-Two-Dimensional-Input-Space-Exploration/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="AbstractFile systems, a basic building block of an OS, are too big and too complex to be bug free. Nevertheless, file systems rely on regular stress-testing tools and formal checkers to find bugs, whi">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/12/30/x254mrQz8qTFJ9d.png">
<meta property="og:image" content="https://i.loli.net/2021/01/01/iBDJ2wfSGUPqO9s.png">
<meta property="article:published_time" content="2020-12-30T06:08:25.000Z">
<meta property="article:modified_time" content="2024-03-27T05:21:36.080Z">
<meta property="article:author" content="Wei CHEN">
<meta property="article:tag" content="Kernel">
<meta property="article:tag" content="File System">
<meta property="article:tag" content="Fuzzing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/12/30/x254mrQz8qTFJ9d.png">


<link rel="canonical" href="https://harperchen.github.io/blog/2020/12/30/S-P-19-Fuzzing-File-Systems-via-Two-Dimensional-Input-Space-Exploration/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://harperchen.github.io/blog/2020/12/30/S-P-19-Fuzzing-File-Systems-via-Two-Dimensional-Input-Space-Exploration/","path":"2020/12/30/S-P-19-Fuzzing-File-Systems-via-Two-Dimensional-Input-Space-Exploration/","title":"[S&P'19] Fuzzing File Systems via Two-Dimensional Input Space Exploration"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[S&P'19] Fuzzing File Systems via Two-Dimensional Input Space Exploration | Wei's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Wei's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Abstract"><span class="nav-number">1.</span> <span class="nav-text">Abstract</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Outline"><span class="nav-number">2.</span> <span class="nav-text">Outline</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wei CHEN"
      src="/blog/images/8.jpg">
  <p class="site-author-name" itemprop="name">Wei CHEN</p>
  <div class="site-description" itemprop="description">Be Brave; Be Confident; <br> Be Happy; Be Optimistic; </div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/harperchen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;harperchen" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:harperchen1110@gmail.com" title="E-Mail → mailto:harperchen1110@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harperchen.github.io/blog/2020/12/30/S-P-19-Fuzzing-File-Systems-via-Two-Dimensional-Input-Space-Exploration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/8.jpg">
      <meta itemprop="name" content="Wei CHEN">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
      <meta itemprop="description" content="Be Brave; Be Confident; <br> Be Happy; Be Optimistic; ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[S&P'19] Fuzzing File Systems via Two-Dimensional Input Space Exploration | Wei's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [S&P'19] Fuzzing File Systems via Two-Dimensional Input Space Exploration
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-30 14:08:25" itemprop="dateCreated datePublished" datetime="2020-12-30T14:08:25+08:00">2020-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-27 13:21:36" itemprop="dateModified" datetime="2024-03-27T13:21:36+08:00">2024-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Papers/" itemprop="url" rel="index"><span itemprop="name">Papers</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h4 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h4><p>File systems, a basic building block of an OS, are too big and too complex to be bug free. Nevertheless, file systems rely on regular stress-testing tools and formal checkers to find bugs, which are limited due to the ever-increasing complexity of both file systems and OSes. Thus, fuzzing, proven to be an effective and a practical approach, becomes a preferable choice, as it does not need much knowledge about a target. However, three main challenges exist in fuzzing file systems: mutating a large image blob that degrades overall performance, generating image-dependent file operations, and reproducing found bugs, which is difficult for existing OS fuzzers.</p>
<span id="more"></span>

<p>Hence, we present JANUS, the first feedback-driven fuzzer that explores the two-dimensional input space of a file system, i.e., mutating metadata on a large image, while emitting image-directed file operations. In addition, JANUS relies on a library OS rather than on traditional VMs for fuzzing, which enables JANUS to load a fresh copy of the OS, thereby leading to better reproducibility of bugs. We evaluate JANUS on eight file systems and found 90 bugs in the upstream Linux kernel, 62 of which have been acknowledged. Forty-three bugs have been fixed with 32 CVEs assigned. In addition, JANUS achieves higher code coverage on all the file systems after fuzzing 12 hours, when compared with the state-of-the-art fuzzer Syzkaller for fuzzing file systems. JANUS visits 4.19× and 2.01× more code paths in Btrfs and ext4, respectively. Moreover, JANUS is able to reproduce 88–100% of the crashes, while Syzkaller fails on all of them.</p>
<p><img src="https://i.loli.net/2020/12/30/x254mrQz8qTFJ9d.png" alt="image-20201230222916796"></p>
<h4 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h4><ul>
<li>Two component of file system 1）disk image 2）file system-specific operation</li>
<li>Drawbacks of previous work on detecting bugs in file system<ul>
<li>Stress testing：focus on the regression of file systems with minimal integrity checks</li>
<li>Model checking：需要对文件系统和内核状态有深层次的理解，不再适用于目前越来越复杂的操作系统</li>
<li>Fuzzing：只在file system的一个维度上做测试，但实际上文件系统的状态决定了系统调用可以在哪个文件对象上操作，而且系统调用的执行也更改了文件系统的状态，因此两者是互相作用、互相依赖的。而现有工作<ul>
<li>要么只将disk image作为二进制文件来mutate，例如kAFL和FuzzBSD</li>
<li>要么只生成随机的操作文件的系统调用序列，例如Syzkaller、Trinity和TriforceAFL，不知道文件系统状态的情况下，无法对文件系统执行有效的操作</li>
<li>而且还不重启内核和刷新文件系统的状态，导致很多bug无法复现</li>
</ul>
</li>
</ul>
</li>
<li>Difficulties of fuzzing file systems<ul>
<li>输入一：a mounted disk image；输入二：a sequence of file operations (system calls)</li>
<li>Mutate a large image blob will degrade overall performance<ul>
<li>disk image虽然是有结构的，但是很复杂，有的还是AFL maximum preferred size的100倍。由于读、写和保存image包含大量的IO操作，会极大降低Fuzzing的吞吐量。</li>
<li>现有mutate image仅修改非零chunks，不完整且效率不高，因为没有利用文件系统的布局，实际上修改metadata block比data blocks更有效。</li>
<li>在不了解文件系统布局的情况下，现有Fuzzer很难在修改metadata后修复metadata checksum</li>
</ul>
</li>
<li>How to generate image-dependent file operations<ul>
<li>现有工作仅执行系统调用操作image上的file objects，但不知道image上到底有多少有效的文件可供操作</li>
<li>Syzkaller无法探索一组系统调用的集体影响，例如对同一路径执行多个open操作但是这个路径可能早就renamed或者removed</li>
</ul>
</li>
<li>How to reproduce found bugs<ul>
<li>不重启会导致不稳定，系统调用的行为不一致（例如kmalloc），而且还不好debug</li>
</ul>
</li>
</ul>
</li>
<li>Disk image<ul>
<li>包含用户数据和元数据metadata，其中元数据仅占有1%的大小</li>
</ul>
</li>
<li>Why this paper is accepted<ul>
<li>The first feedback-driven fuzzer explores the two-dimensional input space of a file system (不仅修改文件系统镜像中的元数据，而且还生成用于特定镜像的文件操作)</li>
<li>Usefulness<ul>
<li>Found 90 bugs in eight widely-used file systems in upstream kernel</li>
<li>Provide clean state OS for file system fuzzing which enable crash reproduce and debug</li>
</ul>
</li>
<li>Novelty<ul>
<li>Propose to mutate both the image bytes and file operations, in which image fuzzing is given higher priors</li>
<li>Muate file system image: mutate metadata blocks instead of data chunks and fix checksum</li>
<li>Mutate file system related syscall trace: generate context-aware workloads instead of blindly fuzzing file system</li>
</ul>
</li>
</ul>
</li>
<li>How it works：schedule image mutator and system call fuzzer<ul>
<li>生成初始corpus<ul>
<li>1）利用image parser从最初的image中提取元数据；</li>
<li>2）检索初始image状态，找到文件路径、类型等，组成测试用例；</li>
<li>3）为每个测试用例，生成初始程序，以操作该文件对象</li>
</ul>
</li>
<li>对于每个corpus里的test case<ul>
<li>1）保持system call trace不变mutate image；</li>
<li>2）几轮之后如果没有发现new coverage，再恢复image到最初状态，mutate system call的参数；</li>
<li>3）几轮之后如果没有发现new coverage，再在现有syscall trace基础上添加新的系统调用</li>
</ul>
</li>
<li>How to mutate a large image blob<ul>
<li>shrunken blob，仅操作和保存元数据为seed，约占1%的比例</li>
<li>mutate metadata block, e.g. bit flipping, set interesting value (0, -1, INT_MAX)</li>
<li>add unchanged user data, recalculate checksum</li>
</ul>
</li>
<li>How to generate image-dependent file operations<ul>
<li>不仅生成系统调用序列，还根据系统调用的功能猜测系统调用执行后，每个文件对象的状态</li>
<li>对于普通参数的mutate，按照Syzkaller的生成方式</li>
<li>对于与文件相关的参数的mutate，则利用抽取的文件系统的状态，选择合适的路径和属性等</li>
</ul>
</li>
<li>How to reproduce found bugs<ul>
<li>每次都fresh操作系统状态 library OS LKL<ul>
<li>LKL exposes kernel interfaces to user-space programs</li>
</ul>
</li>
<li>使LKL支持KASAN<ul>
<li>KASAN在运行时分配shadow memory来记录内存中每个byte是否可以访问</li>
</ul>
</li>
<li>为了performance，利用写时复制技术，只有在发生写操作的时候才复制image</li>
</ul>
</li>
</ul>
</li>
<li>Implementation<ul>
<li>Implementation complexity of JANUS：AFL的基础上进行修改，加上了image mutator和system call fuzzer</li>
<li>支持34个文件系统相关的系统调用：read(), write(), open(), seek(), mmap(), getdents64(), pread64(), pwrite64(), stat(), lstat(), rename(), fsync(), fdatasync(), syncfs(), sendfile(), access(), ftruncate(), truncate(), fstat(), statfs(), fstatfs(), utimes(), mkdir(), rmdir(), link(), unlink(), symlink(), readlink(), chmod(), fchmod(), setxattr(), fallocate(), listxattr(), and removexattr()</li>
<li>Mutate metadata for 256 rounds, the same as the non-deterministic mutation havoc stage for AFL</li>
</ul>
</li>
<li>Evaluation<ul>
<li>8个文件系统Fuzz了四个月，找到90个漏洞，其中62个被确认，43个被修复，32个CVE</li>
<li>比较coverage时，将AFL格式的coverage&#x3D;&gt;Syzkaller格式的coverage再做对比<ul>
<li>其实Syzkaller的coverage计算方式更容易产生碰撞</li>
<li>Syzkaller用PC地址低32位代表每个basic block</li>
<li>AFL用随机数代表每个basic block</li>
</ul>
</li>
<li>Fuzz image but executing fixed file operations<ul>
<li>Syzkaller：syz_mount_image；non-zero chunks</li>
<li>1.47-4.17x covered path after fuzzing 12h</li>
</ul>
</li>
<li>Fuzz file operations without mutating file system image<ul>
<li>at most 2.24x more paths</li>
</ul>
</li>
<li>Exploring two-dimensional input space<ul>
<li>Achieve more path coverage than both individual component, showing that fuzz file system via two dimentiional is necessary</li>
<li>at most 4.19x code paths</li>
</ul>
</li>
<li>使用library OS，与Syzkaller相比，Janus可以复现95%的crash，而Syzkaller却不能</li>
</ul>
</li>
<li>Reflection</li>
<li>Appendix</li>
</ul>
<img src="https://i.loli.net/2021/01/01/iBDJ2wfSGUPqO9s.png" alt="image-20210101221541157" style="zoom:40%;" />

<ul>
<li>Upstream kernel是linux社区维护的内核，Downstream kernel是厂商自己定制的内核</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/Kernel/" rel="tag"># Kernel</a>
              <a href="/blog/tags/File-System/" rel="tag"># File System</a>
              <a href="/blog/tags/Fuzzing/" rel="tag"># Fuzzing</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2020/12/29/USENIX-18-Charm-Facilitating-Dynamic-Analysis-of-Device-Drivers-of-Mobile-Systems/" rel="prev" title="[USENIX'18] Charm: Facilitating Dynamic Analysis of Device Drivers of Mobile Systems">
                  <i class="fa fa-angle-left"></i> [USENIX'18] Charm: Facilitating Dynamic Analysis of Device Drivers of Mobile Systems
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2020/12/30/Thread-Safety/" rel="next" title="Thread Safety">
                  Thread Safety <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Wei CHEN</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  






  





</body>
</html>
