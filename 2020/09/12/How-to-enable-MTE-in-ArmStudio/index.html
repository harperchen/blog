<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"harperchen.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="Configure memory tagging extension (MTE) using Arm Studio and FVP">
<meta property="og:type" content="article">
<meta property="og:title" content="How to enable MTE in ArmStudio">
<meta property="og:url" content="https://harperchen.github.io/blog/2020/09/12/How-to-enable-MTE-in-ArmStudio/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="Configure memory tagging extension (MTE) using Arm Studio and FVP">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/01/08/UFo7AisZ5atbpTN.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/5ZnDHcfzp7g2Ete.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/1ZYN6OHr72yK5mD.png">
<meta property="og:image" content="https://i.loli.net/2021/01/09/ienoAZRtrlGN81q.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/GSuYmN56f7HU4Tc.png">
<meta property="og:image" content="https://i.loli.net/2021/01/09/cQ1n6FT2BWSkrNu.png">
<meta property="og:image" content="https://i.loli.net/2021/01/09/9g2iLuIcX5F1Mw3.png">
<meta property="og:image" content="https://i.loli.net/2021/01/09/9tuxMpL24WYkTbD.png">
<meta property="og:image" content="https://i.loli.net/2021/01/09/yOPKiXlDL2MdwWv.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/cx59vKWUawRXgmq.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/xuUp61mEygM8wIZ.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/qM589KRpbtOY471.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/4uRYwUbH9WLcXiE.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/EBrboUiMlPXp1dC.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/t8Q9qLOFH4exJjS.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/zYnjXhFoC2BkfyZ.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/l7Odx8M9kNcTIBY.png">
<meta property="og:image" content="https://i.loli.net/2021/01/09/6YwZzt5bysAkiTe.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/Pjwoi7bypYxdD5r.png">
<meta property="og:image" content="https://i.loli.net/2021/01/08/Oa4c6rYB7fZoFLR.png">
<meta property="article:published_time" content="2020-09-12T10:47:16.000Z">
<meta property="article:modified_time" content="2024-03-27T05:21:36.077Z">
<meta property="article:author" content="Wei CHEN">
<meta property="article:tag" content="ARM">
<meta property="article:tag" content="MTE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/01/08/UFo7AisZ5atbpTN.png">


<link rel="canonical" href="https://harperchen.github.io/blog/2020/09/12/How-to-enable-MTE-in-ArmStudio/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://harperchen.github.io/blog/2020/09/12/How-to-enable-MTE-in-ArmStudio/","path":"2020/09/12/How-to-enable-MTE-in-ArmStudio/","title":"How to enable MTE in ArmStudio"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>How to enable MTE in ArmStudio | Wei's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Wei's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wei CHEN"
      src="/blog/images/8.jpg">
  <p class="site-author-name" itemprop="name">Wei CHEN</p>
  <div class="site-description" itemprop="description">Be Brave; Be Confident; <br> Be Happy; Be Optimistic; </div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/harperchen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;harperchen" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:harperchen1110@gmail.com" title="E-Mail → mailto:harperchen1110@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harperchen.github.io/blog/2020/09/12/How-to-enable-MTE-in-ArmStudio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/8.jpg">
      <meta itemprop="name" content="Wei CHEN">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
      <meta itemprop="description" content="Be Brave; Be Confident; <br> Be Happy; Be Optimistic; ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="How to enable MTE in ArmStudio | Wei's Blog">
      <meta itemprop="description" content="Configure memory tagging extension (MTE) using Arm Studio and FVP">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          How to enable MTE in ArmStudio
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-12 18:47:16" itemprop="dateCreated datePublished" datetime="2020-09-12T18:47:16+08:00">2020-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-27 13:21:36" itemprop="dateModified" datetime="2024-03-27T13:21:36+08:00">2024-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/ARM/" itemprop="url" rel="index"><span itemprop="name">ARM</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">Configure memory tagging extension (MTE) using Arm Studio and FVP</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><strong>Prerequisites:</strong></p>
<ol>
<li>Download and install Arm Development Studio for either <a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/101469/2000/Installation/Installing-on-Linux?lang=en">Linux</a> or <a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/101469/2000/Installation/Installing-on-Windows?lang=en">Windows</a>. Obtain a 30-day evaluation license so that the project can be built successfully.</li>
<li>Download and install Armv8-A Base RevC AEM FVP (Fixed Virtual Platform) that supports Memory Tagging Extension for <a target="_blank" rel="noopener" href="https://silver.arm.com/download/download.tm?pv=4799001&p=3042387">Linux</a> (No windows version online, need to be compiled by ourselves).</li>
</ol>
<span id="more"></span>

<p><strong>Procedure</strong></p>
<ol>
<li>Create a new C project, select: File &gt; New &gt; Project.</li>
</ol>
<img src="https://i.loli.net/2021/01/08/UFo7AisZ5atbpTN.png" style="zoom:30%;" />

<ol start="2">
<li>Expand C&#x2F;C++ menu, and select C project, then click Next.</li>
<li>Give the project a name, select project type as Executable &gt; Empty Project, then select Arm Compiler 6 Toolchains.</li>
<li>Add asm and src directory, create main.c file under src directory. The asm directory is organized as follows.</li>
</ol>
<img src="https://i.loli.net/2021/01/08/5ZnDHcfzp7g2Ete.png" style="zoom:30%;" />

<p>The FVP is a bare metal so startup.S is the startup code used to setup cache, MMU, stak and enable hardware floating point, etc. Without the startup code, even the simplest printf function cannot be executed. The startup code setups environment, then jumps to C library init code __main to execute the real function. We need to specify the entry point as start64 to run startup code at first.</p>
<img src="https://i.loli.net/2021/01/08/1ZYN6OHr72yK5mD.png" style="zoom:35%;" />

<ol start="5">
<li><p><strong>Right-click the project and select Properties to configure the project for further build.</strong></p>
<p> a. In the Tool Settings tab, select All Tools Settings &gt; Target to specify the Target CPU. Here I select Cortex-A76 AArch64 (The target CPU may be not 100% consistent to the real FVP, but it should be OK.)</p>
 <img src="https://i.loli.net/2021/01/09/ienoAZRtrlGN81q.png" style="zoom:30%;" />

<p> b. Select Arm C Compiler 6 &gt; Target, enable tool specific settings. We need to add <strong>+memtag</strong> feature in -mcpu option to provide hardware support for memory tagging, for more detailed information, please refer to <a target="_blank" rel="noopener" href="https://www.keil.com/support/man/docs/armclang_ref/armclang_ref_chr1392632801932.htm">armclang_ref</a>.</p>
 <img src="https://i.loli.net/2021/01/08/GSuYmN56f7HU4Tc.png" style="zoom:30%;" />

<p> c. Select Arm C Compiler 6 &gt; Miscellaneous, add flag <strong>-fsanitize&#x3D;memtag</strong> so that the compiler will use memory tagging instructions (IRG, ADDG, SUBG…) during code generation to protect the memory allocations on the stack. For more detailed information, please refer to <a target="_blank" rel="noopener" href="https://www.keil.com/support/man/docs/armclang_ref/armclang_ref_lnk1549304794624.htm">armclang_ref</a>.</p>
 <img src="https://i.loli.net/2021/01/09/cQ1n6FT2BWSkrNu.png" style="zoom:30%;" />

<p> d. Select Arm Linker 6 &gt; Image Layout, specify the <strong>entry point as start64</strong>, then browse the scatter file.</p>
 <img src="https://i.loli.net/2021/01/09/9g2iLuIcX5F1Mw3.png" style="zoom:30%;" />

<p> e. Scatter file set up the RO base address (run the code from memory 0x80000000), etc.</p>
 <img src="https://i.loli.net/2021/01/09/9tuxMpL24WYkTbD.png" style="zoom:30%;" />

<p> f. Select Arm Linker 6 &gt; Miscellaneous, add flag <strong>–library_security&#x3D;v8.5a</strong>. This flag lets the armlink link the code with the library that compiled with memory tagging extension to provide full memory tagging stack protection. For more detailed information, please refer to <a target="_blank" rel="noopener" href="https://www.keil.com/support/man/docs/armclang_ref/armclang_ref_snk1537815692994.htm">armclang_ref</a>.</p>
 <img src="https://i.loli.net/2021/01/09/yOPKiXlDL2MdwWv.png" style="zoom:30%;" />

<p> v8.5 not only provides memory tagging protection of the stack used by the library code, but also branch protection using Branch Target Identification (BTI) and Pointer Authentication Code (PAC).<br> To enable heap protection with memory tagging (malloc, realloc, free..), we need to add code __asm(“.global __use_memtag_heap\n\t”) in C file.</p>
</li>
<li><p>Build the project, the Debug directory will be generated. When the project has built, in the Project Explorer view, under Debug, locate the HelloWorld.axf file. The .axf file contains the object code and debug symbols that enable Arm Debugger to perform source-level debugging.</p>
</li>
<li><p><strong>Configure a debugging session to launch the FVP and connect to it.</strong></p>
</li>
</ol>
<ul>
<li>Create a use_model_semihostting.ds script to disable semihosting by Arm Debugger.</li>
</ul>
<img src="https://i.loli.net/2021/01/08/cx59vKWUawRXgmq.png" style="zoom:30%;" />

<ul>
<li>Select File &gt; New &gt; Model Connection, give the connection a name and associate debug connection with an existing project.</li>
</ul>
<img src="https://i.loli.net/2021/01/08/xuUp61mEygM8wIZ.png" style="zoom:30%;" />

<ul>
<li>The FVP Armv8-A Base RevC AEM is not involved by default so we need to add it. Select the model from file system, the path is where you install Armv8-A Base RevC AEM.</li>
</ul>
<img src="https://i.loli.net/2021/01/08/qM589KRpbtOY471.png" style="zoom:30%;" />

<ul>
<li>Once added, we need to edit the debug configuration. In the Connection tab, select Bare Metal Debug&#x2F;ARMAEMv8-A_MPx4 SMP Cluster 0.</li>
</ul>
<img src="https://i.loli.net/2021/01/08/4uRYwUbH9WLcXiE.png" style="zoom:30%;" />

<p>Add the model parameters as follows to enable MTE support.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cluster0.has_arm_v8-5=1 implements the Armv8.5 extension.</span></span><br><span class="line"><span class="comment"># cluster0.memory_tagging_support_level=2 specifies the memory tagging extension support level, 2 means supported at EL0 only.</span></span><br><span class="line"><span class="comment"># bp.dram_metadata.is_enabled=1 lets the memory system to support storing MTE tags.</span></span><br><span class="line"><span class="comment"># bp.secure_memory=false disables the TZC-400 TrustZone memory controller included in the Base_A53x1 FVP. By default, the memory controller refuses all accesses to DRAM memory.</span></span><br><span class="line">\-C cluster0.has_arm_v8-5=1 -C cluster0.memory_tagging_support_level=2 -C bp.dram_metadata.is_enabled=1 -C bp.secure_memory=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/01/08/EBrboUiMlPXp1dC.png" style="zoom:30%;" />

<ul>
<li>In the Files tab, select .axf file under Debug directory from workspace.</li>
</ul>
<img src="https://i.loli.net/2021/01/08/t8Q9qLOFH4exJjS.png" style="zoom:30%;" />

<ul>
<li>In the Debuger tab, select Debug from entry point start64, enable run target initialization debugger script and select .ds script from workspace.</li>
</ul>
<img src="https://i.loli.net/2021/01/08/zYnjXhFoC2BkfyZ.png" style="zoom:30%;" />

<ol start="8">
<li>Click Debug to load the application on the target, and load the debug information into the debugger. The application stops at the entry point start64.</li>
</ol>
<img src="https://i.loli.net/2021/01/08/l7Odx8M9kNcTIBY.png" style="zoom:30%;" />

<ol start="9">
<li>In the disassembly view, we search main to get the assembly instructions of main. The presence of IRG, ADDG shows the code is generated using memory tagging instructions. We set a breakpoint at ADDG instruction, let the program stop at this breakpoint.</li>
</ol>
<p><img src="https://i.loli.net/2021/01/09/6YwZzt5bysAkiTe.png" style="zoom:30%;" /><img src="https://i.loli.net/2021/01/08/Pjwoi7bypYxdD5r.png" style="zoom:30%;" /></p>
<p>Let the program continue to execute and finally we can see “Hello world!” from target console.</p>
<img src="https://i.loli.net/2021/01/08/Oa4c6rYB7fZoFLR.png" style="zoom:45%;" />

<p><strong>Use-after-free</strong></p>
<p><strong>Reference:</strong></p>
<ol>
<li><p>Armv8.5-A Memory Tagging Extension White Paper <a target="_blank" rel="noopener" href="https://developer.arm.com/-/media/Arm%20Developer%20Community/PDF/Arm_Memory_Tagging_Extension_Whitepaper.pdf">https://developer.arm.com/-/media/Arm%20Developer%20Community/PDF/Arm_Memory_Tagging_Extension_Whitepaper.pdf</a></p>
</li>
<li><p>Arm Architecture Registers Manual for Armv8-A Architecture Profile. <a target="_blank" rel="noopener" href="http://harperchen.qiniudn.com/SysReg_xml_v86A-2020-06.pdf">http://harperchen.qiniudn.com/SysReg_xml_v86A-2020-06.pdf</a></p>
</li>
<li><p>Arm A64 Instruction Set Architecture Manual for Armv8-A Architecture Profile. <a target="_blank" rel="noopener" href="http://harperchen.qiniudn.com/ISA_A64_xml_v86A-2020-06_OPT.pdf">http://harperchen.qiniudn.com/ISA_A64_xml_v86A-2020-06_OPT.pdf</a></p>
</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/ARM/" rel="tag"># ARM</a>
              <a href="/blog/tags/MTE/" rel="tag"># MTE</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2020/09/12/CGroup-Experiment/" rel="prev" title="CGroup Experiments">
                  <i class="fa fa-angle-left"></i> CGroup Experiments
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2020/09/13/Ph.D.-Related/" rel="next" title="Ph.D. Related">
                  Ph.D. Related <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Wei CHEN</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  






  





</body>
</html>
